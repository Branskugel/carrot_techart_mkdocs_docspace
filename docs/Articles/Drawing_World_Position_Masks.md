# Рисование масок в мировых координатах


## Применение {: id="purpose"}

Позволяет рисовать в пространстве мировых координат маску вслед за движением объекта. Такую маску можно тут же считывать в любом материале для получения эффектов сохраняющих своё состояние в пространстве. Например, следы от проехавшего автомобиля или приминаемая трава, которая остаётся лежать, когда автомобиль уже проехал.


## Инструкция {: id="how-to"}

>[!warning] Внимание 
>Сразу хочу предупредить. На первый взгляд процесс может показаться запутанным и непонятным. Лучше читать не торопясь и повторять вдумчиво. Но, собрав один раз, вы уже будете иметь у себя на вооружении очень полезную вещь.

### Подготовка ассетов {: id="assets"}

Для начала нам понадобится целый ряд ассетов, которые нужно создать и правильно настроить:

* [[#Canvas Render Target]] Texture - это наш холст
* [[#rvt|Runtime Virtual Texture]] - это его отражение в мировых координатах
* [[#Brush Properties|Материал "кисти"]] для рисования по холсту
* [[#MPC|Material Parameter Collection]] - универсальный пересылатель данных от блюпринта рисователя к кисти и, таким образом, к текстуре. **Опционален**
* [[#canvas-material|Материал холста]]. **Опционален**.

![[WP_Masks_Assets_1.png]]{style="border-radius: 5px"}


```Unreal 

'RYM_Utilities/Materials/Misc/RTT_to_RVT_Masking/' | 'BPC_MaskPainter'

```

$\quad$Если вставить этот текст в строку поиска в панели Content Browser, находясь в папке All, то отобразятся все ассеты имеющие отношение к теме. Так что, по большому счёту, всё, что я здесь упоминаю можно самостоятельно не создавать, а просто скопировать из плагина. 

![[WP_Masks_Assets_2.png]]{style="border-radius: 5px"}

Но в таком случае нужно обязательно переименовать свои копии этих ассетов, чтобы не было задваивания с плагином, которое может в дальнейшем сыграть злую шутку. Поэтому далее я буду описывать работу так, словно у нас изначально ничего нет. Ну кроме блюпринта.


#### Canvas Render Target

Это наш будущий холст. На самом деле "холстов" у нас здесь целых три в каком-то смысле, а кистей две, но обо всём по порядку.

$\quad$Этот ассет мы создаём в разрешении не больше чем 2048 на 2048, так как большое разрешение нам здесь вряд ли будет когда либо полезно или нужно. Меньше - лучше.


#### Runtime Virtual Texture или RVT {: id="rvt"}

Это наш второй холст. Он необходим для того, чтобы записанную в Canvas Render Target текстуру информацию можно было легко считать в том месте в мировых координатах, где она была записана. Эдакий конвертер в данном случае.


#### Материал кисти {: id="brush-material"}

Он должен быть *транслюсентным* и изображать некую маску в \[0-1\] UV координатах, хотя бы на канале opacity, когда как в Emissive можно подавать уже любую информацию. Если никаких наворотов не нужно, то можно просто заткнуть Emissive белым цветом.

![[WP_Masks_SimpleBrushMaterial.png]]{style="border-radius: 5px"}

В плагине же поставляется кисть немного посложнее. Она поддерживает запись направления движения объекта и маска у неё настроена определённым образом.


#### Материал холста {: id="canvas-material"}

На самом деле материал холста несколько опционален. В том смысле, что его не обязательно создавать как что-то отдельное и его функционал может быть встроен в существующий, если ваша сцена вам позволяет.


![[WP_Masks_CanvasMaterial.png]]{style="border-radius: 5px"}

На скриншоте представлен материал поставляемый с плагином - **M_RTT_RVT_Converter**. Его Blend Mode задан как *masked*, а в канал opacity подаётся значение 0, чтобы не отображаться в сцене, но всё ещё не считаться скрытым как при активированном свойстве Hidden in game.

$\quad$Особенность материала холста заключается в передаче данных Canvas Render Target текстуры в RVT посредством ноды Runtime Virtual Texture Output. На скриншоте между ними кастомная нода MF_UnmultiplyAlpha. Она используется для инверсии эффекта альфы на цветовой канал, чтобы он приходил из текстуры так, как задумано. 


#### MPC

Material Parameter Collection ассет, через который будут передаваться обновляемые данные. Предназначен для более продвинутого использования. Например, для передачи направления движения объекта.


### Работа со сценой {: id="scene-entities"}
#### Третий холст {: id="mesh-canvas"}

Собственно меш, находящийся в сцене и, в пределах которого мы хотим рисовать маску. В идеале это просто плоскость. Меш-холст должен всегда отображаться в сцене, но может быт полностью прозрачным opacity mask.

$\quad$**Коллизии** этого меша должны быть настроены соответствующим образом, чтобы он реагировал на [[#blueprint-brush|кисть-блюпринт]] и ни на что более.

![[WP_Masks_MeshCanvasCollisionSettings.png]]{style="border-radius: 5px"}


Так же, в категории **Virtual Texture** нужно указать RVT холст, на который будет наноситься изображение.

![[WP_Masks_CanvasMesh_RVT_slot.png]]{style="border-radius: 5px"}

#### Добавляем блюпринт-кисть {: id="add-blueprint-brush"}

**BPC_MaskPainter** - это блюпринт-инструмент, представляющий собой особый scene компонент. В точке своего прикрепления к объекту он осуществляет line trace проверку на наличие под или над ним объекта-холста. Если он его находит, то в этой точке рисует на Canvas Render Target текстуре нашим материалом-кистью. В него заранее имплементирована возможность работы с MPC для записи кастомных данных или вектора направления движения.

Добавляется простым перетаскиванием в иерархию компонентов объекта.

![[WP_Masks_BPC_MaskPainter_ExampleHierarchy.png]]{style="border-radius: 5px"}

`Пример расположения в иерархии другого актора. Компонент добавлен экземпляру блюпринта на уровне - "снаружи"`

### Работа с блюпринтом {: id="bpc-maskpainter-setup"}

Все параметры этого компонента можно настроить как на экземпляре внутри родительского блюпринта, так и на добавленном "снаружи" - на уровне


#### Параметры {: id="bpc-maskpainter-parameters"}

##### Setup

![[WP_Masks_BPC_MaskPainter_SetupParams.png]]{style="border-radius: 5px"}

* **Actor Layer** - название слоя, акторы которого будут отфильтрованы из проверки инструмента, чтобы его "выстрелы" проходили только по Canvas Object[^1]
* **Clear Color** - цвет, на который сбрасывается Canvas Render Target
* **Clear Before Drawing** ✅ - активация сброса Canvas Render Target текстуры до Clear Color цвета перед началом рисования


##### Brush Properties

![[WP_Masks_BPC_MaskPainter_BrushProperties.png]]{style="border-radius: 5px"}

* **Material Brush** - Материал кисти, используемый для рисования на Canvas Render Target текстуре
* **Brush Size** - Размер кисти
* **Use Brush Rotation** ✅ - активация использования поворота кисти
* **Brush Rotation** - поворот кисти
* **Update Brush Rotation** ✅ - активация обновления поворота кисти во время рисования
* **Brush Rotation From Local Direction** ✅ - переключение способа вычисления вращения кисти от движения на вектор направления относительный родительского актора
* **Trace Location Z Range** - Длина луча ищущего холст от центра самого компонента BPC_MaskPainter
* **Send Data to MPC** - переключает поведение отправки данных в MPC. Подробнее в подсказке при наведении мышью
* **MPC** - Material Parameter Collection ассет, используемый для передачи данных
* **MPC Parameter Name** - название параметра MPC, который будет перезаписываться
* **Invert Direction Vector** ✅ - инверсия вектора направления

##### Canvas Properties

![[WP_Masks_BPC_MaskPainter_CanvasProperties.png]]{style="border-radius: 5px"}

* **Canvas Object** - объект служащий холстом в сцене
* **Canvas Render Target** - соответствующая RTT текстура
* **Canvas Object UV Channel** - UV канал холста, используемый для рисования на Canvas Render Target текстуре.

##### Animation

![[WP_Masks_BPC_MaskPainter_AnimationParams.png]]{style="border-radius: 5px"}

* **Strokes Frequency** - частота нанесения мазков на текстуру в секунду. Больше - плавнее, но дороже, так что не всегда лучше.
* **Spline Actor** - Актор со spline компонентом, по которому может двигаться сам BPC_MaskPainter или его родитель.
* **AnimTime** - Время рисования в секундах.
* **Autoplay?** ✅ - Активация автоматического старта рисования с началом игры

#### Рисование {: id="bpc-maskpainter-drawing"}

После настройки параметров компонента можно перейти к активации его в управляющем (или родительском) блюпринте.









[^1]: Удалять его из слоя не нужно, он сам себя вычитает из выборки.






