# Шейдерная анимация по сплайну

#RYM_Utilities

Ситуация: Вам нужно запустить объект или набор объектов-инстансов в движение по заданной траектории и сделать это на материале, потому что: либо объект тяжёлый, либо анимируется с помощью VAT текстур и (например) Houdini функции в материале.
$\quad$Справиться с этой задачей нам поможет ряд инструментов: [[SplineBaker]], [[BP_RandomInstanceShaderGrid]], <u>любой</u> сплайн, в том числе [[SplinePath]]

#### Краткая инструкция:

1. Создаём на уровне экземпляр сплайна, если ещё нет. Можно использовать идущий с плагином Spline Path
2. Добавляем на уровень Spline Baker из панели Place actors
3. Копируем к себе MPC_BakedSpline_CTRL_1 и MPC_BakedSpline_Limits_1 и указываем свою версию последнего инструменту.
4.  Указываем сплайн и настраиваем.
5. Нажимаем последовательно кнопки Bake Spline Data to RTT, Save Limits to MPC, Save RT to Texture Asset
6. Копируем содержимое мастер-материала MM_SplineGridVATInstances и подключаем в своём. 
7. Подменяем коллекции параметров на свои и создаём инстанс(ы) материала.
8. Указываем в инстансе текстуру с запечённым сплайном. 
9. Настраиваем на уровне экземпляр BP_RandomInstanceShaderGrid
10. В своей версии MPC_BakedSpline_Limits_1 прописываем размер желаемой сетки инстанцирования и в своей версии MPC_BakedSpline_CTRL_1 её настраиваем. Там же настраиваем и прочие трансформы инстансов.

Эта инструкция приведена здесь для быстрого освежения в памяти алгоритма работы с этим инструментарием для тех, кто им уже пользовался ранее. Ниже после описания самих инструментов будет более подробная инструкция.

### Работа с материалом

Вот этот большой блок нодов нам нужно скопировать в мастер-материал своих будущих инстансов, чтобы наделить их возможностью перемещаться по запечённой в текстуру траектории посредством материала.

![[MM_SplineGridVATInstances.png]]{style="border-radius: 5px"}
`Материал MM_SplineGridVATInstances` 

1. Выделяем всё и копипастим в свой материал.
2. Подменяем ассеты MaterialParameterCollection на свои.
3. Подключаем предшествующие трансформации во вход WPO (World Position Offset) функции MF_SplineTransforms, а выход в материал.
4. Во вход World Normals подключаем нормали предшествующих трансформаций или VertexNormalWS если их нет.
5. Делаем [[A_bit_on_materials#Концепция Мастер-инстанса|мастер-инстанс]] материала для удобства, если ещё не сделали и наследуем от него все остальные инстансы материала

#### Параметры инстанса материала


![[MI_SplineGridVATInstances_master.png]]{style="border-radius: 5px"}

`Для этого скриншота было включено отображение ВСЕХ (в том числе неактивных) параметров для демонстрации полного списка`

* **IsInstance** - переключает поведение некоторых рассчётов в материале на учитывание специфики работы с инстансами
* **Override grid socket** - позволяет записать инстансам координаты ячейки вручную, в обход данных записываемых блюпринтом
* **Auto Playback** - Автовоспроизведение анимации движения
* **IsClosedLoop** - переключает логику движения на концах сплайна, полезно для зацикливающихся сплайнов
* **ReverseDirection** - инвертирует направление движения
* **Game Time at First Frame** - пауза до начала анимации при включённой опции Auto Playback
* **Display Frame** - ручное значение положения на сплайне по колличеству пикселей (кадров) в горизонтальном разрешении текстуры
* **Playback Speed** - Множитель скорости воспроизведения анимации
* **FPS** - кол-во кадров в секунду
* **Interframe Interpolation (Spline)** - переключает использование "межкадровой" интерполяции. **При задействовании рекомендуется** использовать не большое горизонтальное разрешение текстуры-сплайна для достижения наиболее плавной интерполяции.
* **Spline** (текстура) - ассет в который была произведена запечка траектории с помощью SplineBaker
* **GridFromCenter** - сместить ли сетку инстанцирования центром к пивоту
* **OnlyPositionAlongSpline** - забирать ли со сплайна только положение в пространстве
* **SplineAffectsRotation** - влияет ли сплайн на вращение инстансов
* **UseRoll** - использовать ли продольное вращение
* **OnlyRoll** - исключить ли другое вращение кроме продольного
* **RollAffectsPosition** - использовать ли кривую в качестве пивота для продольного вращения, вместо самих инстансов
* **RollAffectsRotation** - добавлять ли продольное вращение к обычному
* **CustomRoll** - использовать ли кастомный Roll настроенный на SplinePath
  
Статья будет дополнена информацией о работе с материалом в ближайшем будущем.